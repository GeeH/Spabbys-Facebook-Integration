<?php
class MGames_FacebookAuth
{
    private $_fbid;
    private $_fbSigs;
    private $_fbSettings;
    public $fbSigs;
    public $isAuthed = false;
    public $hasInstalled = false;

    public function __construct($fbSigs, $settings)
    {
        $this->_fbSettings = $settings;
        $this->_fbSigs = $fbSigs;
        $this->_parse_signed_request();
    }

    public function getFBID()
    {
        return $this->_fbid;
    }

    public function getFBSigs()
    {
        return $this->_fbSigs;
    }

    private function _parse_signed_request()
    {
        if (!is_string($this->_fbSigs) || empty($this->_fbSigs))
        {
            $this->isAuthed = false;
            return false;
        }
        list($encoded_sig, $payload) = explode('.', $this->_fbSigs, 2);

        // decode the data
        $sig = $this->_base64_url_decode($encoded_sig);
        $data = json_decode($this->_base64_url_decode($payload), true);

        if (strtoupper($data['algorithm']) !== 'HMAC-SHA256')
        {
            $this->isAuthed = false;
            return false;
        }

        // check sig
        $expected_sig = hash_hmac('sha256', $payload, $this->_fbSettings->AppSecret, $raw = true);
        if ($sig !== $expected_sig) 
        {
            $this->isAuthed = false;
            return false;
        }

        $this->isAuthed = true;
        $this->fbSigs = $data;

        if (isset($this->fbSigs['oauth_token']) && is_string($this->fbSigs['oauth_token']) && !empty($this->fbSigs['oauth_token']))
        {
            $this->hasInstalled = true;
        }
        if (isset($this->fbSigs['user_id']) && is_string($this->fbSigs['user_id']) && !empty($this->fbSigs['user_id']))
        {
            $this->_fbid = $this->fbSigs['user_id'];
        }
        else
        {
            $this->_fbid = '0';
            $this->isAuthed = false;
        }
        return true;
    }

    private function _base64_url_decode($input)
    {
        return base64_decode(strtr($input, '-_', '+/'));
    }
}
?>
